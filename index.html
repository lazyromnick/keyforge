<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="description" content="Generate, encrypt, and manage your passwords securely. Fully offline — zero data sent anywhere." />
  <meta name="mobile-web-app-capable" content="yes" />

  <title>KeyForge — Smart Password Manager</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Favicons (no Apple touch icons per request) -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png" />

  <link rel="./css/stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>

  <!-- ░░░ AUTH SCREEN ░░░ -->
  <div id="auth-screen" class="screen active">
    <div class="auth-card">
      <div class="auth-logo"><i class="bi bi-shield-lock-fill"></i></div>
      <h1 class="auth-title">KeyForge</h1>
      <p class="auth-subtitle" id="auth-mode-label">Enter your master password to unlock your vault</p>

      <div class="input-group">
        <label for="master-password"><i class="bi bi-key-fill"></i> Master Password</label>
        <div class="password-input-wrap">
          <input type="password" id="master-password" placeholder="Enter master password…" autocomplete="current-password" />
          <button class="toggle-vis" id="toggle-master-vis" aria-label="Toggle visibility"><i class="bi bi-eye"></i></button>
        </div>
        
        <div class="input-group" id="confirm-group" style="display:none;">
        <label for="confirm-password"><i class="bi bi-check2-circle"></i> Confirm Master Password</label>
        <input type="password" id="confirm-password" placeholder="Confirm password…" autocomplete="new-password" />
      </div>
      </div>

      <!-- PIN setup on first launch -->
      <div id="pin-setup-group" style="display:none;">
        <div class="pin-setup-divider"><span><i class="bi bi-grid-3x3-gap-fill"></i> Optional Quick PIN</span></div>
        <p class="pin-setup-hint">Set a 4–6 digit PIN for faster unlocking. Leave blank to skip.</p>
        <div class="input-group">
          <label for="setup-pin"><i class="bi bi-123"></i> PIN (4–6 digits)</label>
          <input type="tel" id="setup-pin" placeholder="e.g. 1234" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
        </div>
        <div class="input-group">
          <label for="setup-pin-confirm"><i class="bi bi-check2-circle"></i> Confirm PIN</label>
          <input type="tel" id="setup-pin-confirm" placeholder="Confirm PIN" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
        </div>
      </div>

      <div id="strength-bar-wrap" style="display:none;">
        <div class="strength-bar"><div class="strength-fill" id="master-strength-fill"></div></div>
        <span class="strength-label" id="master-strength-label"></span>
      </div>

      <div id="auth-error" class="auth-error" style="display:none;"></div>

      <button class="btn-primary full-width" id="unlock-btn">
        <i class="bi bi-unlock-fill"></i> <span id="unlock-btn-text">Unlock Vault</span>
      </button>

      <button class="btn-ghost full-width" id="switch-to-pin-btn" style="display:none;">
        <i class="bi bi-grid-3x3-gap-fill"></i> Use PIN instead
      </button>

      <p class="auth-hint" id="auth-switch-hint">
        First time? <a href="#" id="switch-auth-mode">Create a new vault</a>
      </p>
    </div>
    <div class="auth-bg-grid"></div>
  </div>

  <!-- ░░░ PIN SCREEN ░░░ -->
  <div id="pin-screen" class="screen" style="display:none;">
    <div class="pin-card">
      <div class="auth-logo"><i class="bi bi-grid-3x3-gap-fill"></i></div>
      <h2 class="pin-title">Quick Unlock</h2>
      <p class="pin-subtitle">Enter your PIN to open KeyForge</p>

      <div class="pin-dots" id="pin-dots">
        <span class="pin-dot" id="dot-0"></span>
        <span class="pin-dot" id="dot-1"></span>
        <span class="pin-dot" id="dot-2"></span>
        <span class="pin-dot" id="dot-3"></span>
        <span class="pin-dot" id="dot-4"></span>
        <span class="pin-dot" id="dot-5"></span>
      </div>

      <div id="pin-error" class="auth-error" style="display:none;"></div>

      <div class="numpad">
        <button class="numpad-key" data-digit="1">1</button>
        <button class="numpad-key" data-digit="2">2<span>ABC</span></button>
        <button class="numpad-key" data-digit="3">3<span>DEF</span></button>
        <button class="numpad-key" data-digit="4">4<span>GHI</span></button>
        <button class="numpad-key" data-digit="5">5<span>JKL</span></button>
        <button class="numpad-key" data-digit="6">6<span>MNO</span></button>
        <button class="numpad-key" data-digit="7">7<span>PQRS</span></button>
        <button class="numpad-key" data-digit="8">8<span>TUV</span></button>
        <button class="numpad-key" data-digit="9">9<span>WXYZ</span></button>
        <button class="numpad-key numpad-action" id="pin-use-master-btn" title="Use master password">
          <i class="bi bi-key-fill"></i>
        </button>
        <button class="numpad-key" data-digit="0">0</button>
        <button class="numpad-key numpad-action" id="pin-backspace-btn" title="Backspace">
          <i class="bi bi-delete-left-fill"></i>
        </button>
      </div>

      <p class="pin-alt-hint"><a href="#" id="pin-use-master-link">Use master password instead</a></p>
    </div>
    <div class="auth-bg-grid"></div>
  </div>

  <!-- ░░░ MAIN APP ░░░ -->
  <div id="app-screen" class="screen" style="display:none;">

    <!-- Top Bar — mobile only -->
    <header class="topbar">
      <div class="topbar-logo">
        <i class="bi bi-shield-lock-fill"></i>
        <span>KeyForge</span>
      </div>
      <div class="topbar-right">
        <div class="topbar-timer">
          <i class="bi bi-hourglass-split"></i>
          <span id="timer-display">5:00</span>
        </div>
        <button class="btn-lock" id="lock-btn"><i class="bi bi-lock-fill"></i></button>
      </div>
    </header>

    <!-- Sidebar — desktop only -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <i class="bi bi-shield-lock-fill"></i>
        <span>KeyForge</span>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-panel="generator">
          <i class="bi bi-stars"></i><span>Generator</span>
        </button>
        <button class="nav-item" data-panel="vault">
          <i class="bi bi-safe2-fill"></i><span>Vault</span>
          <span class="vault-count" id="vault-count">0</span>
        </button>
        <button class="nav-item" data-panel="settings">
          <i class="bi bi-gear-fill"></i><span>Settings</span>
        </button>
      </nav>
      <div class="sidebar-footer">
        <div class="inactivity-timer" title="Auto-lock timer">
          <i class="bi bi-hourglass-split"></i>
          <span id="timer-display-sidebar">5:00</span>
        </div>
        <button class="btn-lock" id="lock-btn-sidebar"><i class="bi bi-lock-fill"></i></button>
      </div>
    </aside>

    <!-- Content -->
    <main class="main-content">

      <!-- Generator Panel -->
      <section id="panel-generator" class="panel active">
        <div class="panel-header">
          <h2><i class="bi bi-stars"></i> Generator</h2>
          <p>Craft an unbreakable password</p>
        </div>

        <div class="generator-layout">
          <div class="password-output-card">
            <div class="password-output-wrap">
              <span id="generated-password" class="password-display">Tap Generate</span>
              <div class="output-actions">
                <button class="icon-btn" id="copy-password-btn" title="Copy" disabled><i class="bi bi-clipboard"></i></button>
                <button class="icon-btn" id="regenerate-btn" title="Regenerate" disabled><i class="bi bi-arrow-clockwise"></i></button>
              </div>
            </div>
            <div class="strength-meter">
              <div class="strength-segments">
                <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
              </div>
              <span class="strength-text" id="strength-text">—</span>
            </div>
            <div class="clipboard-notice" id="clipboard-notice" style="display:none;">
              <i class="bi bi-check-circle-fill"></i> Copied! Clearing in <span id="countdown">15</span>s
            </div>
          </div>

          <div class="generator-controls">
            <div class="control-group">
              <label>
                <span><i class="bi bi-rulers"></i> Length</span>
                <span class="length-value" id="length-value">16</span>
              </label>
              <input type="range" id="length-slider" min="6" max="64" value="16" />
            </div>
            <div class="control-group">
              <span class="section-label"><i class="bi bi-toggles"></i> Character Types</span>
              <div class="checkbox-grid">
                <label class="checkbox-item">
                  <input type="checkbox" id="opt-upper" checked /><span class="checkbox-box"></span><span>Uppercase <em>A–Z</em></span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" id="opt-lower" checked /><span class="checkbox-box"></span><span>Lowercase <em>a–z</em></span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" id="opt-numbers" checked /><span class="checkbox-box"></span><span>Numbers <em>0–9</em></span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" id="opt-symbols" /><span class="checkbox-box"></span><span>Symbols <em>!@#…</em></span>
                </label>
              </div>
            </div>
            <div class="control-group">
              <span class="section-label"><i class="bi bi-slash-circle"></i> Options</span>
              <label class="checkbox-item">
                <input type="checkbox" id="opt-exclude-ambiguous" /><span class="checkbox-box"></span><span>Skip ambiguous <em>O 0 l 1</em></span>
              </label>
            </div>
            <button class="btn-primary full-width" id="generate-btn">
              <i class="bi bi-lightning-charge-fill"></i> Generate Password
            </button>
          </div>
        </div>

        <div class="save-form-card" id="save-form" style="display:none;">
          <h3><i class="bi bi-floppy-fill"></i> Save to Vault</h3>
          <div class="save-fields">
            <div class="input-group">
              <label for="save-site"><i class="bi bi-globe"></i> Website / App</label>
              <input type="text" id="save-site" placeholder="e.g. github.com" />
            </div>
            <div class="input-group">
              <label for="save-username"><i class="bi bi-person-fill"></i> Username / Email</label>
              <input type="text" id="save-username" placeholder="e.g. user@email.com" />
            </div>
          </div>
          <div class="save-actions">
            <button class="btn-secondary" id="cancel-save-btn"><i class="bi bi-x-lg"></i> Cancel</button>
            <button class="btn-primary" id="confirm-save-btn"><i class="bi bi-floppy-fill"></i> Save</button>
          </div>
        </div>

        <button class="btn-accent full-width" id="open-save-form-btn" style="display:none;">
          <i class="bi bi-plus-circle-fill"></i> Save to Vault
        </button>
      </section>

      <!-- Vault Panel -->
      <section id="panel-vault" class="panel">
        <div class="panel-header">
          <h2><i class="bi bi-safe2-fill"></i> Vault</h2>
          <p>Your encrypted credentials</p>
        </div>
        <div class="vault-toolbar">
          <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input type="search" id="vault-search" placeholder="Search…" />
          </div>
          <button class="btn-secondary btn-icon-label" id="download-vault-btn" title="Export encrypted vault as ZIP">
            <i class="bi bi-download"></i><span>Export</span>
          </button>
        </div>
        <div id="vault-empty" class="vault-empty" style="display:none;">
          <i class="bi bi-safe2"></i>
          <p>Your vault is empty.<br/>Generate and save a password to get started.</p>
        </div>
        <div id="vault-list" class="vault-list"></div>
      </section>

      <!-- Settings Panel -->
      <section id="panel-settings" class="panel">
        <div class="panel-header">
          <h2><i class="bi bi-gear-fill"></i> Settings</h2>
          <p>Security preferences</p>
        </div>
        <div class="settings-list">
          <div class="settings-card">
            <div class="settings-card-header">
              <div class="settings-icon"><i class="bi bi-grid-3x3-gap-fill"></i></div>
              <div class="settings-info">
                <h4>Quick PIN</h4>
                <p id="pin-status-text">Checking…</p>
              </div>
              <span class="settings-badge" id="pin-badge"></span>
            </div>
            <div class="settings-card-actions">
              <button class="btn-primary" id="set-pin-btn"><i class="bi bi-plus-circle"></i> <span id="set-pin-btn-text">Set PIN</span></button>
              <button class="btn-danger" id="remove-pin-btn" style="display:none;"><i class="bi bi-trash3-fill"></i> Remove</button>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <div class="settings-icon"><i class="bi bi-hourglass-split"></i></div>
              <div class="settings-info">
                <h4>Auto-lock Timeout</h4>
                <p>Lock vault after inactivity</p>
              </div>
            </div>
            <div class="settings-card-actions">
              <select id="timeout-select" class="settings-select">
                <option value="60">1 minute</option>
                <option value="180">3 minutes</option>
                <option value="300" selected>5 minutes</option>
                <option value="600">10 minutes</option>
                <option value="1800">30 minutes</option>
              </select>
            </div>
          </div>

          <div class="settings-card settings-danger-card">
            <div class="settings-card-header">
              <div class="settings-icon danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
              <div class="settings-info">
                <h4>Danger Zone</h4>
                <p>Permanently wipe all vault data</p>
              </div>
            </div>
            <div class="settings-card-actions">
              <button class="btn-danger" id="wipe-vault-btn"><i class="bi bi-trash3-fill"></i> Wipe Vault</button>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- Bottom Nav — mobile only -->
    <nav class="bottom-nav">
      <button class="bottom-nav-item active" data-panel="generator">
        <i class="bi bi-stars"></i><span>Generator</span>
      </button>
      <button class="bottom-nav-item" data-panel="vault">
        <div class="bottom-nav-icon-wrap">
          <i class="bi bi-safe2-fill"></i>
          <span class="bottom-badge" id="bottom-vault-count" style="display:none;">0</span>
        </div>
        <span>Vault</span>
      </button>
      <button class="bottom-nav-item" data-panel="settings">
        <i class="bi bi-gear-fill"></i><span>Settings</span>
      </button>
    </nav>
  </div>

  <!-- SET PIN MODAL -->
  <div id="set-pin-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div class="modal-header">
        <h3><i class="bi bi-grid-3x3-gap-fill"></i> <span id="set-pin-modal-title">Set Quick PIN</span></h3>
        <button class="modal-close" id="set-pin-modal-close"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">Your PIN is AES-encrypted with your master password key — it cannot be brute-forced without it.</p>
        <div class="input-group">
          <label for="new-pin"><i class="bi bi-123"></i> New PIN (4–6 digits)</label>
          <input type="tel" id="new-pin" placeholder="4 to 6 digits" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
        </div>
        <div class="input-group">
          <label for="new-pin-confirm"><i class="bi bi-check2-circle"></i> Confirm PIN</label>
          <input type="tel" id="new-pin-confirm" placeholder="Confirm PIN" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
        </div>
        <div id="set-pin-error" class="auth-error" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="set-pin-cancel"><i class="bi bi-x-lg"></i> Cancel</button>
        <button class="btn-primary" id="set-pin-save"><i class="bi bi-floppy-fill"></i> Save PIN</button>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div class="modal-header">
        <h3><i class="bi bi-pencil-square"></i> Edit Entry</h3>
        <button class="modal-close" id="modal-close-btn"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-entry-id" />
        <div class="input-group">
          <label for="edit-site"><i class="bi bi-globe"></i> Website / App</label>
          <input type="text" id="edit-site" />
        </div>
        <div class="input-group">
          <label for="edit-username"><i class="bi bi-person-fill"></i> Username / Email</label>
          <input type="text" id="edit-username" />
        </div>
        <div class="input-group">
          <label for="edit-password"><i class="bi bi-key-fill"></i> Password</label>
          <div class="password-input-wrap">
            <input type="password" id="edit-password" />
            <button class="toggle-vis" id="toggle-edit-vis"><i class="bi bi-eye"></i></button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="modal-cancel-btn"><i class="bi bi-x-lg"></i> Cancel</button>
        <button class="btn-primary" id="modal-save-btn"><i class="bi bi-floppy-fill"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE MODAL -->
  <div id="confirm-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card modal-card-sm">
      <div class="modal-header">
        <h3><i class="bi bi-exclamation-triangle-fill"></i> Delete Entry</h3>
      </div>
      <div class="modal-body">
        <p>Delete <strong id="confirm-delete-site"></strong>? This cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="confirm-cancel-btn"><i class="bi bi-x-lg"></i> Cancel</button>
        <button class="btn-danger" id="confirm-delete-btn"><i class="bi bi-trash3-fill"></i> Delete</button>
      </div>
    </div>
  </div>

  <!-- WIPE MODAL -->
  <div id="wipe-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card modal-card-sm">
      <div class="modal-header">
        <h3><i class="bi bi-exclamation-triangle-fill"></i> Wipe Vault</h3>
      </div>
      <div class="modal-body">
        <p>This permanently deletes <strong>all</strong> credentials and resets your vault. No undo.</p>
        <div class="input-group" style="margin-top:1rem;">
          <label for="wipe-confirm-input">Type <strong>WIPE</strong> to confirm</label>
          <input type="text" id="wipe-confirm-input" placeholder="WIPE" autocomplete="off" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="wipe-cancel-btn"><i class="bi bi-x-lg"></i> Cancel</button>
        <button class="btn-danger" id="wipe-confirm-btn" disabled><i class="bi bi-trash3-fill"></i> Wipe Everything</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script src="./js/crypto.js"></script>
  <script src="./js/storage.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/app.js"></script>

  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(reg => {
            console.log('[KeyForge] SW registered:', reg.scope);
            // Prompt user when a new SW version is waiting
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available — could show a toast here
                  console.log('[KeyForge] New version available. Reload to update.');
                }
              });
            });
          })
          .catch(err => console.warn('[KeyForge] SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
